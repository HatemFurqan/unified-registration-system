version: '3.8'

services:
  app:
    build:
      args:
        user: ayman
        uid: 1003
        gid: 1003
      context: ./
      dockerfile: Dockerfile
    image: unified-registration
    container_name: unified-registration-app
    restart: unless-stopped
    environment:
      SERVICE_NAME: unified-registration-app
      SERVICE_TAGS: prod
    working_dir: /var/www
    volumes:
      - ./:/var/www
      - ./docker/local.ini:/usr/local/etc/php/conf.d/local.ini
    networks:
      - proxy

  nginx:
    image: nginx:1.17-alpine
    container_name: unified-registration-webserver
    restart: unless-stopped
    tty: true
    volumes:
      - ./:/var/www
      - ./docker/nginx-app.conf:/etc/nginx/conf.d/default.conf
      - ./storage/logs/nginx/error.log:/var/log/nginx/error.log
      - ./storage/logs/nginx/access.log:/var/log/nginx/access.log
    networks:
      - proxy
    depends_on:
      - app
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.unified-registration.rule=Host(`furqanshop.com`) && PathPrefix(`/unified-registration`)"
      - "traefik.http.routers.unified-registration.entrypoints=http"
      - "traefik.http.routers.unified-registration.middlewares=unified-registration-add-slash,unified-registration-security@docker"
      - "traefik.http.routers.unified-registration.entrypoints=https"
      - "traefik.http.routers.unified-registration.tls=true"
      - "traefik.http.routers.unified-registration.tls.certresolver=cloudflare"
      - "traefik.http.middlewares.unified-registration-security.headers.contentsecuritypolicy=upgrade-insecure-requests"
      - "traefik.http.middlewares.unified-registration-add-slash.redirectregex.regex=^(https?://[^/]+/unified-registration)$$"
      - "traefik.http.middlewares.unified-registration-add-slash.redirectregex.replacement=$${1}/"
      - "traefik.http.middlewares.unified-registration-add-slash.redirectregex.permanent=true"

networks:
  proxy:
    external: true
